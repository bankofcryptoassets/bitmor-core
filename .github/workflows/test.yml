name: Loan Provider CI

permissions:
    contents: read

on:
    push:
    pull_request:
    workflow_dispatch:

env:
    FOUNDRY_PROFILE: ci

jobs:
    loan-provider-tests:
        name: Loan Provider Tests
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: loan-provider
        steps:
            - uses: actions/checkout@v5
              with:
                  persist-credentials: false
                  submodules: recursive

            - name: Install Foundry
              uses: foundry-rs/foundry-toolchain@v1

            - name: Cache Foundry dependencies
              uses: actions/cache@v3
              with:
                  path: |
                      ~/.foundry
                      lib
                  key: ${{ runner.os }}-foundry-${{ hashFiles('**/foundry.toml', '**/remappings.txt') }}
                  restore-keys: |
                      ${{ runner.os }}-foundry-

            - name: Install dependencies
              run: forge install

            - name: Show Forge version
              run: forge --version

            - name: Run Forge fmt check
              run: forge fmt --check

            - name: Run Forge build
              run: forge build --sizes

            - name: Run Forge tests
              run: make test -vvv

            - name: Generate gas report
              run: make gasReport

    security-checks:
        name: Security Checks
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: loan-provider
        steps:
            - uses: actions/checkout@v5
              with:
                  persist-credentials: false
                  submodules: recursive

            - name: Install Foundry
              uses: foundry-rs/foundry-toolchain@v1

            - name: Cache Foundry dependencies
              uses: actions/cache@v3
              with:
                  path: |
                      ~/.foundry
                      lib
                  key: ${{ runner.os }}-foundry-${{ hashFiles('**/foundry.toml', '**/remappings.txt') }}
                  restore-keys: |
                      ${{ runner.os }}-foundry-

            - name: Install dependencies
              run: forge install

            - name: Install Slither
              run: pip3 install slither-analyzer

            - name: Run Slither analysis
              run: slither . --exclude-dependencies
              continue-on-error: true

    coverage:
        name: Coverage Report
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: loan-provider
        steps:
            - uses: actions/checkout@v5
              with:
                  persist-credentials: false
                  submodules: recursive

            - name: Install Foundry
              uses: foundry-rs/foundry-toolchain@v1

            - name: Cache Foundry dependencies
              uses: actions/cache@v3
              with:
                  path: |
                      ~/.foundry
                      lib
                  key: ${{ runner.os }}-foundry-${{ hashFiles('**/foundry.toml', '**/remappings.txt') }}
                  restore-keys: |
                      ${{ runner.os }}-foundry-

            - name: Install dependencies
              run: forge install

            - name: Generate coverage report
              run: make coverageLCOV

            - name: Upload coverage to Codecov
              uses: codecov/codecov-action@v3
              with:
                  file: ./loan-provider/lcov.info
                  fail_ci_if_error: false
